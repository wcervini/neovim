-- lua/plugins/deepseek.lua (CONFIGURACIÃ“N SEGURA)
return {
  -- cmp-ai para DeepSeek
  {
    "tzachar/cmp-ai",
    dependencies = { "hrsh7th/nvim-cmp" },
    config = function()
      -- FunciÃ³n segura para obtener API key
      local function get_deepseek_key()
        -- 1. Variable de entorno (RECOMENDADO)
        local key = os.getenv("DEEPSEEK_API_KEY")
        if key and key ~= "" then
          return key
        end
        
        -- 2. Archivo en Windows
        local home = os.getenv("USERPROFILE") or os.getenv("HOME")
        if home then
          local key_file = home .. "\\.deepseek_key"
          if vim.fn.filereadable(key_file) == 1 then
            local content = vim.fn.readfile(key_file)
            if #content > 0 then
              return content[1]
            end
          end
        end
        
        -- 3. No encontrada
        vim.notify(
          "âš ï¸  DeepSeek API key no encontrada\n\n" ..
          "Configura con:\n" ..
          "1. export DEEPSEEK_API_KEY='tu_key'\n" ..
          "2. O crea: %USERPROFILE%\\.deepseek_key\n\n" ..
          "ObtÃ©n una key GRATIS en:\n" ..
          "ðŸ‘‰ https://platform.deepseek.com/api-keys",
          vim.log.levels.WARN,
          { title = "DeepSeek", timeout = 10000 }
        )
        
        return nil
      end
      
      local api_key = get_deepseek_key()
      
      if api_key then
        require("cmp_ai.config"):setup({
          max_lines = 1000,
          provider = "OpenAI",  -- Â¡IMPORTANTE! Usar "OpenAI"
          model = "deepseek-chat",
          api_key = api_key,
          api_base = "https://api.deepseek.com/v1",
          run_on_every_keystroke = true,
          trigger_on_newline = false,
          ignored_file_types = {
            "tex",        -- No usar en LaTeX
            "markdown",   -- Opcional
            "gitcommit",  -- Opcional
          },
        })
        
        vim.notify("âœ… DeepSeek autocompletado ACTIVADO", vim.log.levels.INFO)
      else
        -- Crear comando para configurar key manualmente
        vim.api.nvim_create_user_command("DeepSeekSetup", function()
          local key = vim.fn.input("Introduce tu API Key de DeepSeek: ", "")
          if key and key ~= "" then
            vim.fn.system(string.format('echo %s > "%s\\.deepseek_key"', 
              vim.fn.shellescape(key), 
              os.getenv("USERPROFILE")))
            vim.notify("Key guardada. Reinicia Neovim.", vim.log.levels.INFO)
          end
        end, {})
        
        vim.notify("Usa :DeepSeekSetup para configurar tu API key", vim.log.levels.INFO)
      end
    end
  }
}
